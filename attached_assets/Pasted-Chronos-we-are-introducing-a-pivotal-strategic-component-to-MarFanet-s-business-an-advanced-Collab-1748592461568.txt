Chronos, we are introducing a pivotal strategic component to MarFanet's business: an advanced Collaborator (همکار - Affiliate/Partner) program. This requires a sophisticated system for managing collaborators, calculating their commissions based on the sales of Representatives (mobile stores) they introduce, tracking their earnings, processing payouts, and providing detailed, transparent reporting for all stakeholders (Admins, Collaborators, and indirectly, the Representatives themselves).

Core Concept Refined:
MarFanet works with two types of Representatives:

    Direct Representatives: Mobile stores that are direct clients.
    Indirect/Collaborator-Introduced Representatives: Mobile stores introduced and potentially managed by "Collaborators." These Collaborators earn commissions from the V2Ray subscription sales generated by the Representatives they onboarded.

I. "Manage Collaborators" (مدیریت همکاران / تعریف همکار) Section within Admin Panel:

    Directive: Create a dedicated section for full lifecycle management of Collaborator profiles.
    Functionality:
        Admin can create, view, edit, and delete Collaborator profiles.
        Collaborator Profile Fields:
            Collaborator Name (نام همکار)
            Unique Collaborator ID
            Contact Information (Phone, Telegram ID - with https://t.me/ prefix auto-applied, Email)
            Secure placeholder or encrypted storage for Bank Account Details (for commission payouts).
            Current Accumulated Earnings Balance (موجودی درآمد انباشته): Dynamically displays total unpaid commission (in Toman, Green for positive). This is the primary balance for payouts.
            Total Earnings To Date (جمع کل درآمد از ابتدا)
            Total Payouts To Date (جمع کل تسویه حساب‌ها از ابتدا)
            Status (Active/Inactive/Pending Approval).
            Date Joined.
    Action (Chronos): Design UI and backend logic for Collaborator profile management.

II. Enhancements to "Define/Manage Representative" (تعریف/مدیریت نماینده) Section:

    New Field: "Representative Sourcing Type" (نوع جذب نماینده):
        Options: "Direct," "Introduced by Collaborator" (همکاری).
    Conditional Logic if "Introduced by Collaborator" is selected:
        "Assign to Collaborator" (انتخاب همکار): Dropdown/searchable list of active Collaborators. This establishes the crucial link.
        "Volume Subscription Commission Rate (%) for this Rep under this Collaborator" (پورسانت اشتراک حجمی): Percentage input.
        "Unlimited Subscription Commission Rate (%) for this Rep under this Collaborator" (پورسانت اشتراک نامحدود): Percentage input.
        (Consideration: Should these rates be inheritable from a Collaborator's default rates but overridable per Rep? For now, assume per-Rep specific rates under a Collaborator).
    Data Integrity: Ensure a Representative can only be linked to one Collaborator at a time.
    Action (Chronos): Modify the Representative management form, backend logic, and database schema to include these fields and relationships.

III. Automated Commission Calculation & Real-time Tracking:

    Trigger: Commissions are calculated and attributed immediately upon successful generation of an invoice for an Indirect/Collaborator-Introduced Representative.
    Calculation Logic:
        For each invoice generated for such a Representative:
            Retrieve the linked Collaborator and their specific commission rates (Volume & Unlimited) for that specific Representative.
            The invoice generation process MUST accurately differentiate revenue from "Volume Subscriptions" and "Unlimited Subscriptions" sold to the Representative's end-customers.
            Commission = (Rep's Total Sales from Volume Plans on Invoice * Volume Comm. Rate %) + (Rep's Total Sales from Unlimited Plans on Invoice * Unlimited Comm. Rate %)
        The calculated commission amount is immediately added to the Collaborator's "Current Accumulated Earnings Balance."
        A detailed, immutable record of each commission transaction (Collaborator ID, Associated Representative ID, Associated Invoice ID, Date, Revenue Type (Volume/Unlimited), Base Revenue Amount, Commission Rate Applied, Commission Amount Earned) MUST be stored for auditing and reporting.
    Action (Chronos): Integrate this logic into invoice generation. Design database tables for commission records. Ensure atomic updates to Collaborator balances.

IV. Collaborator Payout (Settlement) System (within "Manage Collaborators"):

    Functionality:
        Admin can "Record Payout" for a Collaborator.
        Admin enters payout amount (in Toman).
        This payout amount is deducted from the Collaborator's "Current Accumulated Earnings Balance."
        The system must handle partial payouts correctly (e.g., balance of 10M Toman, payout of 5M Toman, new balance is 5M Toman).
    Payout History: Maintain a detailed log of all payouts (Collaborator ID, Date, Amount Paid, Admin User who processed).
    Action (Chronos): Design UI and backend for recording payouts and updating balances and history.

V. Advanced AI-Powered Reporting & Transparency:

    For Collaborators (via Admin): "Detailed Earnings Report" (ریز جزئیات درآمد همکار)
        Location: Within each Collaborator's profile.
        Functionality (Powered by Vertex AI/Gemini):
            Admin selects timeframe (Shamsi dates - using standardized 1/2/3/4/8 week options or custom date range).
            AI-Generated Report Content:
                Total commission earned in period.
                Total payouts received in period.
                Net change in accumulated earnings.
                Detailed breakdown per invoice batch upload date:
                    List of Representatives under this Collaborator who generated commission in that batch.
                    For each Representative: admin_username, total volume subscription revenue they generated, total unlimited subscription revenue, commission rates applied, and exact commission amount earned by Collaborator from that Representative for that batch.
                Summary of earnings by Representative.
            Export: Downloadable as PDF.
        Action (Chronos): Design data aggregation, Vertex AI/Gemini prompt strategy for this detailed, structured report generation, and PDF export.

    For Representatives (فروشگاه‌ها - Ensuring Their Transparency): "My Performance & Earnings Report"
        Context: While not directly about Collaborator commissions, Representatives need their own clear financial overview. This leverages the "Debtor/Creditor Balance" and "Statement of Account" features previously discussed for Representatives.
        Enhancement for Transparency: Ensure the Representative's "Statement of Account" (ریز جزئیات حساب) accessible to them (or to Admin viewing their profile) clearly shows:
            All invoices issued to them by MarFanet.
            All payments they have made to MarFanet.
            Their current Debtor/Creditor balance with MarFanet.
        Crucial Distinction: This report is about the Representative's financial relationship with MarFanet. It does not show how much commission their introducing Collaborator earned from their sales (that's private to the Collaborator and Admin).
        Action (Chronos): Reconfirm that the existing plans for the Representative's "Statement of Account" are robust and provide this level of detail for the Representative's own accounting with MarFanet.

    For Admins (Overall Collaborator Program Performance - AI Analysis & Reporting Center):
        Action (Chronos): Design new reports/dashboards within the "AI Analysis & Reporting Center" (powered by Vertex AI/Gemini) to provide Admin with insights like:
            Top Earning Collaborators.
            Collaborators with the most referred active Representatives.
            Average commission per Representative by Collaborator.
            Trends in Collaborator program growth and overall commission payouts.
            Analysis of which commission structures (rates for volume vs. unlimited) are most effective.

VI. System Integrity & User Experience:

    All new UIs must be fully responsive and adhere to the MarFanet aesthetic.
    All financial calculations must be precise, logged for audit, and update balances in real-time.
    Ensure data models are scalable for many Collaborators, Representatives, and transactions.

Final Instruction to Chronos:

"Chronos, this comprehensive Collaborator (Affiliate/Partner) Program is a strategic imperative for MarFanet's growth. It involves new data entities, complex financial calculations, multi-stakeholder reporting, and requires deep integration with our existing systems, all powered by Vertex AI for advanced analytics and reporting.

Please confirm your understanding of this entire system, including:

    The distinct management of Collaborators and their linkage to Representatives.
    The commission calculation logic triggered by invoice generation.
    The process for recording and reflecting Collaborator payouts.
    The detailed, AI-powered earnings reports for Collaborators.
    The necessary transparency for Representatives regarding their own accounts with MarFanet.
    The new Admin-level reports on overall Collaborator program performance.

Outline your proposed:

    Database schema additions/modifications (for Collaborators, Rep-Collaborator links, commission rates, earnings ledger, payout ledger).
    Modifications to the Representative management workflow.
    Core logic for commission calculation and balance updates.
    Plan for the AI-powered "Detailed Earnings Report" for Collaborators (data aggregation, Vertex AI/Gemini prompt strategy, PDF export).
    Plan for the new Admin reports on the Collaborator program.

Please prioritize the foundational elements (database, core entities, linking Reps, commission calculation logic) before fully developing all the AI-powered reporting features."